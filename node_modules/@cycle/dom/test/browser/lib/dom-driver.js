"use strict";
var assert = require("assert");
var xstream_1 = require("xstream");
var delay_1 = require("xstream/extra/delay");
var flattenSequentially_1 = require("xstream/extra/flattenSequentially");
var run_1 = require("@cycle/run");
var lib_1 = require("../../../lib");
function createRenderTarget(id) {
    if (id === void 0) { id = null; }
    var element = document.createElement('div');
    element.className = 'cycletest';
    if (id) {
        element.id = id;
    }
    document.body.appendChild(element);
    return element;
}
describe('makeDOMDriver', function () {
    it('should accept a DOM element as input', function () {
        var element = createRenderTarget();
        assert.doesNotThrow(function () {
            lib_1.makeDOMDriver(element);
        });
    });
    it('should accept a DocumentFragment as input', function () {
        var element = document.createDocumentFragment();
        assert.doesNotThrow(function () {
            lib_1.makeDOMDriver(element);
        });
    });
    it('should accept a string selector to an existing element as input', function () {
        var id = 'testShouldAcceptSelectorToExisting';
        var element = createRenderTarget();
        element.id = id;
        assert.doesNotThrow(function () {
            lib_1.makeDOMDriver('#' + id);
        });
    });
    it('should not accept a selector to an unknown element as input', function () {
        assert.throws(function () {
            lib_1.makeDOMDriver('#nonsenseIdToNothing');
        }, /Cannot render into unknown element/);
    });
    it('should not accept a number as input', function () {
        assert.throws(function () {
            lib_1.makeDOMDriver(123);
        }, /Given container is not a DOM element neither a selector string/);
    });
});
describe('DOM Driver', function () {
    it('should throw if input is not an Observable<VTree>', function () {
        var domDriver = lib_1.makeDOMDriver(createRenderTarget());
        assert.throws(function () {
            domDriver({});
        }, /The DOM driver function expects as input a Stream of virtual/);
    });
    it('should have isolateSource() and isolateSink() in source', function (done) {
        function app(sources) {
            return {
                DOM: xstream_1.default.of(lib_1.div()),
            };
        }
        var _a = run_1.setup(app, {
            DOM: lib_1.makeDOMDriver(createRenderTarget()),
        }), sinks = _a.sinks, sources = _a.sources, run = _a.run;
        var dispose = run();
        assert.strictEqual(typeof sources.DOM.isolateSource, 'function');
        assert.strictEqual(typeof sources.DOM.isolateSink, 'function');
        dispose();
        done();
    });
    it('should not work after has been disposed', function (done) {
        var num$ = xstream_1.default.of(1, 2, 3)
            .map(function (x) { return xstream_1.default.of(x).compose(delay_1.default(50)); })
            .compose(flattenSequentially_1.default);
        function app(sources) {
            return {
                DOM: num$.map(function (num) {
                    return lib_1.h3('.target', String(num));
                }),
            };
        }
        var _a = run_1.setup(app, {
            DOM: lib_1.makeDOMDriver(createRenderTarget()),
        }), sinks = _a.sinks, sources = _a.sources, run = _a.run;
        var dispose;
        sources.DOM.select(':root').elements()
            .drop(1)
            .addListener({
            next: function (root) {
                var selectEl = root.querySelector('.target');
                assert.notStrictEqual(selectEl, null);
                assert.notStrictEqual(typeof selectEl, 'undefined');
                assert.strictEqual(selectEl.tagName, 'H3');
                assert.notStrictEqual(selectEl.textContent, '3');
                if (selectEl.textContent === '2') {
                    dispose();
                    setTimeout(function () {
                        done();
                    }, 100);
                }
            },
        });
        dispose = run();
    });
    it('should clean up DOM on disposal', function (done) {
        var hookTick = 0;
        var hookInterval;
        var hook = {
            insert: function () {
                hookInterval = setInterval(function () { return hookTick++; }, 10);
            },
            destroy: function () {
                clearInterval(hookInterval);
            },
        };
        function app() {
            return {
                DOM: xstream_1.default.of(lib_1.h3('.target', { hook: hook }, 'dummy text')),
            };
        }
        var _a = run_1.setup(app, {
            DOM: lib_1.makeDOMDriver(createRenderTarget('disposal')),
        }), sinks = _a.sinks, sources = _a.sources, run = _a.run;
        var dispose = run();
        setTimeout(function () {
            dispose();
            var hookTickOnDisposal = hookTick;
            setTimeout(function () {
                var renderTarget = document.getElementById('disposal');
                assert.equal(renderTarget.innerHTML, '');
                assert.ok(hookTick > 0);
                assert.equal(hookTickOnDisposal, hookTick);
                done();
            }, 50);
        }, 100);
    });
});
